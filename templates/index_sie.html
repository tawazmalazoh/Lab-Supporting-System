{% extends "base_SIE.html" %} 
{% load static %} 
{% load crispy_forms_tags %} 
{% load custom_filters %}
{% block content %}


  <!--  -- E Charts-->
  <script src="https://cdn.jsdelivr.net/npm/echarts@5.2.1/dist/echarts.min.js"></script>


<!-- start Data Table libraries  -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<link rel="stylesheet" href="https://cdn.datatables.net/1.13.5/css/jquery.dataTables.min.css"/>
<link href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.6.0/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdn.datatables.net/v/bs4-4.6.0/jq-3.7.0/jszip-3.10.1/dt-1.13.5/af-2.6.0/b-2.4.1/b-colvis-2.4.1/b-html5-2.4.1/b-print-2.4.1/cr-1.7.0/date-1.5.1/fc-4.3.0/fh-3.4.0/kt-2.10.0/r-2.5.0/rg-1.4.0/rr-1.4.1/sc-2.2.0/sb-1.5.0/sp-2.2.0/sl-1.7.0/sr-1.3.0/datatables.min.css" rel="stylesheet">
 <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/pdfmake.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/vfs_fonts.js"></script>
<script src="https://cdn.datatables.net/v/bs4-4.6.0/jq-3.7.0/jszip-3.10.1/dt-1.13.5/af-2.6.0/b-2.4.1/b-colvis-2.4.1/b-html5-2.4.1/b-print-2.4.1/cr-1.7.0/date-1.5.1/fc-4.3.0/fh-3.4.0/kt-2.10.0/r-2.5.0/rg-1.4.0/rr-1.4.1/sc-2.2.0/sb-1.5.0/sp-2.2.0/sl-1.7.0/sr-1.3.0/datatables.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.6.0/js/bootstrap.min.js"></script>
<!-- end Datatable -->
 
<script>
  var jQuery_3_6_0 = $.noConflict(true);
  </script>
  

<!-- these are libraries for MULTIPLE SELECT -->
<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.1/css/bootstrap.min.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-select/1.13.1/css/bootstrap-select.css" />
<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.1/js/bootstrap.bundle.min.js"></script>
 <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-select/1.13.1/js/bootstrap-select.min.js"></script>
<!-- end of libraries for multiple select -->
<script>
  var jQuery_2_1_1 = $.noConflict(true);
  </script>

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">



<script src=" {% static 'assets/js/echarts.min.js'%}"></script>



<style>
/* Base table styles */
table {
    width: 100%;
    border-collapse: collapse;
}

/* Column borders */
th, td {
    border: 1px solid #dddddd;
    padding: 8px;
    text-align: left;
}

/* Header background */
thead th {
    background-color: #f2f2f2;
}

/* Alternate row colors */
tbody tr:nth-child(odd) {
    background-color: #f9f9f9;
}

tbody tr:nth-child(even) {
    background-color: #ffffff;
}


</style>

  
 <!-- Start Basic Modal -->
<div class="modal fade" id="confirmModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">CONFIRM</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
       Are you sure you want to delete this entry?
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        <button type="button" id="confirmDelete" class="btn btn-primary">Confirm Deletion</button>
      </div>
    </div>
  </div>
</div>
<!-- End Basic Modal -->


      
     
       <div class="row">     
       <div class="col-lg-6">
        {% with now|time_of_day as greeting %}
        <h3>Dashboard : :{{ user.first_name }} {{ user.last_name }}</h3>
        {% endwith %}
        </div>
     
        <div class="d-flex justify-content-end col-lg-6">          
          <a href="{% url 'explore' %}">Download the latest tools: </a>         
      </div>
      
          </div>
       
          <div class="row">  

            <div class="col-lg-12">
              <div class="card">
                  <div class="card-body">
                    <h5 class="card-title"></h5>
                    {% for message in messages %}
                    <div class="alert {{ message.tags }} alert-dismissible fade show" role="alert">
                    <i class="bi bi-exclamation-octagon me-1"></i>
                    {{ message|safe }} <br>      
                  <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                    </div>
                    {% endfor %}    
                    
                    

          
                    {% if msg %} {% autoescape off %} {{ msg }} {% endautoescape %} {% endif %}
                    <div id="msg"></div>
                    <p>
          </div>
                              <!-- Alerts Section -->
                              <div class="progress">
                                <div class="progress-bar" role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100" style="width: 0%;">0%</div>
                            </div>
          </div>
          
          </div>
            
           
          </div>

          
<div class="alert border-warning alert-dismissible fade show" role="alert">
  <div class="row">
  <div class="col-lg-3">
    <i class="bi bi-cpu-fill" style="font-size: 5em;"></i> 
  </div>
<div class="col-lg-8">
  <span style="margin-left: 2em;">
  "Could you kindly rename your files to more accurately reflect their content! For example, if the file contains the VL Published report for Mpilo HIV Lab in July 2023 for Week 3, a suitable name could be 'Mpilo HIV Lab July2023 Week3 VLP ublished Report'."
</div>
</div>
</div>
        
         

<div class="row">
    <div class="col-lg-6">
        <div class="card">
            <div class="card-body">
              <h5 class="card-title">Weekly Dashboard</h5>

           
            <div class="row mb-3">

              <form method="post" enctype="multipart/form-data" id="upload-form">
                {% csrf_token %}
                <label for="inputNumber" class="col-sm-2 col-form-label">File Upload</label>
                <div class="col-sm-10">
                    {{ form.upload_file }}
                </div><br>
                <button type="submit" class="btn btn-primary" id="upload-button">Upload Dashboard</button>
            </form>
            
            <script>
            // jQuery version
            $(document).ready(function () {
                $('#upload-form').on('submit', function () {
                    $('#upload-button').text("Performing analysis... Please do not navigate away from this page.");
                });
            });
            
            // Vanilla JS version
            /*
            document.getElementById('upload-form').addEventListener('submit', function () {
                document.getElementById('upload-button').innerText = 'Loading...';
            });
            */
            </script>
            
            </div>
  </div>
  </div>
  </div>

  <div class="col-lg-6">
    <div class="card">
      <div class="card-body">   

        <fieldset name="Multiple Files Upload">
    {% csrf_token %}
    <h5 class="card-title">UPLOAD OTHER REPORTS</h5>
    <label for="formFileMultiple" class="form-label">Upload other files (select multiple files) -not in zipped  -⚠️ -name according to report❗❗❗</label>

    <input class="form-control" type="file" id="multiFiles" name="files[]" multiple  />       
    <br>
    <!-- <input type="button" id="upload" name="upload" class="btn btn-primary"  > -->
    <button id="upload"  name="upload" class="btn btn-primary">Upload Multiple Files</button>
  
  </fieldset>

  </div>
     </div>
</div>

</div>


<div class="row">
  <div class="col-lg-6">
    <div class="card">
      <div class="card-body">   
     
        <fieldset name="Multiple Files Upload">
    {% csrf_token %}
    <h5 class="card-title"><span style="color: red; font-weight: bold; font-size: 18px;">HUB</span> CREATION REPORTS</h5>
    <label for="formFileMultiple" class="form-label">Upload Hub Creation reports <span style="color: rgb(244, 159, 159); font-weight: bold; font-size: 18px;"> (StandAlone Hubs)  </span> </label>

    <input class="form-control" type="file" id="HUBmultiFiles" name="HUBfiles[]" multiple  />       
    <br>
    <!-- <input type="button" id="upload" name="upload" class="btn btn-primary"  > -->
    <button id="HUBupload"  name="HUBupload" class="btn btn-primary">Upload HUB Files</button>
  
  </fieldset>
  

  </div>
     </div>
</div>

<div class="col-lg-6">
  <div class="card">
    <div class="card-body">   

      <fieldset name="Multiple Files Upload">
  {% csrf_token %}
  <h5 class="card-title"><span style="color: red; font-weight: bold; font-size: 18px;">LAB</span> CREATION REPORTS </h5>


  <label for="formFileMultiple" class="form-label">Upload LAB Creation reports</label>

  <input class="form-control" type="file" id="LABmultiFiles" name="LABfiles[]" multiple  />       
  <br>
  <!-- <input type="button" id="upload" name="upload" class="btn btn-primary"  > -->
  <button id="LABupload"  name="LABupload" class="btn btn-primary">Upload LAB Files</button>

</fieldset>

</div>
   </div>
</div>

</div>



<div class="row">
 <div class="col-lg-12">
  <div class="card">
    <div class="card-body">   
   
      <fieldset name="Multiple Files Upload IST">
  {% csrf_token %}
  <h5 class="card-title"><span style="color: red; font-weight: bold; font-size: 18px;">IST</span> WEEKLY REPORT</h5>
  <label for="formFileMultiple" class="form-label">Upload   the  IST Weekly reports <span style="color: rgb(244, 159, 159); font-weight: bold; font-size: 18px;"> <i> (provincial IST)</i>  </span> </label>

  <input class="form-control" type="file" id="ISTmultiFiles" name="ISTfiles[]" multiple  required/>       
  <br>
  <!-- <input type="button" id="upload" name="upload" class="btn btn-primary"  > -->
  <button id="ISTupload"  name="ISTupload" class="btn btn-primary">Upload IST File</button>

</fieldset>


       </div>
   </div>
</div>
</div>


<div class="row">

<div class="col-lg-6">
  <div class="card">
    <div class="card-body">  
    <h5 class="card-title">SMS uploads </h5> 
          <div class="row mb-3">  
              <fieldset name="Multiple Files Upload">
                  {% csrf_token %}                    
                  <label for="formFileMultiple" class="form-label">Upload the sms excel file </label>                
                  <input class="form-control" type="file" id="smsfiles[]" name="smsfiles[]" multiple  />       
                  <br>                  
                  <button id="smsupload"  name="smsupload" class="btn btn-primary">Upload SMS File(s)</button>                  
                </fieldset>       
          
          </div>
     </div>
   </div>
</div>




<div class="col-lg-6">
  <div class="card">
    <div class="card-body">  
    <h5 class="card-title">DISPATCH LIST </h5> 
          <div class="row mb-3">  
              <fieldset name="Multiple Files Upload">
                  {% csrf_token %}                    
                  <label for="formFileMultiple" class="form-label">Upload the dispatch list file </label>                
                  <input class="form-control" type="file" id="dispatchfiles[]" name="dispatchfiles[]" multiple  />       
                  <br>                  
                  <button id="dispatchupload"  name="dispatchupload" class="btn btn-primary">Upload Dispatch File(s)</button>                  
                </fieldset>       
          
          </div>
     </div>
   </div>
</div>


</div>



<div class="row">
  <div class="col-lg-6" id="uploaded_list">
    <h5 class="card-title">Uploaded Files</h5>
      <!-- Default List group -->
      <ul class="list-group" id="uploaded_files">
          <!-- Placeholder for uploaded files. Will be populated by JavaScript -->
      </ul>
      <!-- End Default List group -->
  </div> 

  <div class="col-lg-6" id="dbuploaded_list">
    <h5 class="card-title">Database Uploaded Files</h5>
    <table>
      <thead>
          <tr> <th></th>
              <th>Update Date</th>
              <th>Source File</th>
              <th>Status</th>
              <th>Entries</th>
          </tr>
      </thead>
      <tbody>
          {% for row in files_uploaded %}
          <tr>
            <td>
              <!-- Call to action buttons -->
              {% load crispy_forms_tags %}
              <form  method="POST" >
                {% csrf_token %}
              <ul class="list-inline m-0">                
                  <li class="list-inline-item">
                    <button class="btn btn-danger btn-sm rounded-0 delete_uploaded_creation"  id="delete_uploaded_creation" name="delete_uploaded_creation"
                          type="button" 
                          data-update_date="{{ row.0 }}" 
                          data-sourcefile="{{ row.1 }}"
                          data-user="{{ row.3 }}" 
                          data-status="{{ row.2 }}" 
                          data-toggle="tooltip" 
                          data-placement="top" 
                          title="Delete">
                          <i class="fas fa-trash"></i>
                      </button>

                
                  </li>                                      
              </ul>
              </form>
          </td>
          <td>{{ row.0}}</td>
              <td>{{ row.1 }}</td>
              <td>{{ row.2 }}</td>
              <td>{{ row.4 }}</td>
          </tr>
          {% endfor %}
      </tbody>
  </table>
  


  <table>
    <thead>
        <tr>
           <th></th>
            <th></th>
            <th></th>
            <th></th>
            <th></th>
         
        </tr>
    </thead>
    <tbody>
        {% for row in dash_uploaded %}
        <tr>
          <td>
            <!-- Call to action buttons -->
            {% load crispy_forms_tags %}
            <form  method="POST" >
              {% csrf_token %}
            <ul class="list-inline m-0">                
                <li class="list-inline-item">
                  <button class="btn btn-danger btn-sm rounded-0 delete_uploaded_dashboard "  id="delete_uploaded_dashboard"
                        type="button" 
                        data-update_date="{{ row.1 }}" 
                        data-sourcefile="{{ row.2 }}"
                        data-unique_key="{{ row.4 }}" 
                        data-toggle="tooltip" 
                        data-placement="top" 
                        title="Delete">
                        <i class="fas fa-trash"></i>
                    </button>

              
                </li>                                      
            </ul>
            </form>
        </td>
        <td>{{ row.0}}</td>
            <td>{{ row.2 }}</td>
            <td>{{ row.3 }}</td>          
        </tr>
        {% endfor %}
    </tbody>
</table>



<table>
  <thead>
      <tr>
         <th></th>
          <th></th>
          <th></th>
          <th></th>    
          <th></th>    
        
      </tr>
  </thead>
  <tbody>
      {% for row in vl_received_uploaded %}
      <tr>
        <td>
          <!-- Call to action buttons -->
          {% load crispy_forms_tags %}
          <form  method="POST" >
            {% csrf_token %}
          <ul class="list-inline m-0">                
              <li class="list-inline-item">
                <button class="btn btn-danger btn-sm rounded-0 delete_uploaded_vl_received"  id="delete_uploaded_vl_received" name="delete_uploaded_vl_received"
                      type="button" 
                      data-vlupdate_date="{{ row.2 }}" 
                      data-vlsourcefile="{{ row.0 }}"
                      data-vluser="{{ row.1 }}" 
                      data-toggle="tooltip" 
                      data-placement="top" 
                      title="Delete">
                      <i class="fas fa-trash"></i>
                  </button>

            
              </li>                                      
          </ul>
          </form>
      </td>
           <td>{{ row.0}}</td>
          <td>{{ row.1 }}</td>
          <td>{{ row.2 }}</td>   
          <td>{{ row.3 }}</td>       
      </tr>
      {% endfor %}
  </tbody>
</table>






</div> 
</div>






  <script src="{% static 'assets/js/custom.js'%}"></script>


<script src="https://code.jquery.com/jquery-3.6.0.min.js"
integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4="
crossorigin="anonymous"
></script>
<script src="https://www.jsdelivr.com/package/npm/jquery"></script>
<script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js"></script>

<script type="text/javascript">
// JavaScript with the custom progress bar
// JavaScript without the progress bar and with button text change
$(document).ready(function (e) {
  $('#upload').on('click', function () {
    var form_data = new FormData();
    var ins = document.getElementById('multiFiles').files.length;
    var submitButton = $('#upload'); // Get the submit button

    if (ins == 0) {
      $('#msg').html('<div class="alert alert-danger" role="alert">Select at least one file</div>');
      return;
    }

    for (var x = 0; x < ins; x++) {
      form_data.append("files[]", document.getElementById('multiFiles').files[x]);
    }

    csrf_token = $('input[name="csrfmiddlewaretoken"]').val();
    form_data.append("csrfmiddlewaretoken", csrf_token);

    // Change the submit button text to "WAITING" when the AJAX request starts
    submitButton.prop('disabled', true).html('WAIT FOR ALL FILES TO BE LOADED...');
    




    $.ajax({
      url: '{% url "upload_other_files" %}', // point to server-side URL
      dataType: 'json', // what to expect back from server
      cache: false,
      contentType: false,
      processData: false,
      data: form_data,
      type: 'post',

      success: function (response) { // display success response
        $('#msg').html('<div class="alert alert-success alert-dismissible fade show" role="alert">' +
                                   '<i class="bi bi-check-circle-fill me-1"></i>' + response.read_response +
                                   '<button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>' +
                                   '</div>');




        document.getElementById('multiFiles').value = ''; // clear the file input field

        
        // Append the uploaded file names to the uploaded_list div
        var uploadedList = $('#uploaded_list ul.list-group');
        var files = response.files; // Assuming the server returns the list of files in a 'files' attribute
        for (var i = 0; i < files.length; i++) {
            uploadedList.append('<li class="list-group-item">' + files[i] + '</li>');
        }


        setTimeout(function() {
                    location.reload();
                }, 3000); // 3000 milliseconds = 3 seconds

        // Restore the submit button text after a short delay (1.5 seconds in this case)
        setTimeout(function () {
          submitButton.prop('disabled', false).html('Upload Multiple Files');
        }, 1500);
      },

      error: function (response) {
        
        $('#msg').html('<div class="alert alert-success alert-dismissible fade show" role="alert">' +
                                   '<i class="bi bi-check-circle-fill me-1"></i>' + response.msg +
                                   '<button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>' +
                                   '</div>');

        document.getElementById('multiFiles').value = ''; // clear the file input field

        // Restore the submit button text after a short delay (1.5 seconds in this case)
        setTimeout(function () {
          submitButton.prop('disabled', false).html('Upload Multiple Files');
        }, 3500);
      }
    });
  });


// for the HUB uploadds 
$('#HUBupload').on('click', function () {
    var form_data = new FormData();
    var ins = document.getElementById('HUBmultiFiles').files.length;
    var submitButton = $('#HUBupload'); // Get the submit button
    var status='Standalone Hubs'

    if (ins == 0) {
      $('#msg').html('<div class="alert alert-danger" role="alert">Select at least one file</div>');
       
      return;
    }

    for (var x = 0; x < ins; x++) {
      form_data.append("HUBfiles[]", document.getElementById('HUBmultiFiles').files[x]);
      //console.log(form_data);
      
    }

        // Append the status to the form data
    form_data.append("status", status);

    csrf_token = $('input[name="csrfmiddlewaretoken"]').val();
    form_data.append("csrfmiddlewaretoken", csrf_token);

    // Change the submit button text to "WAITING" when the AJAX request starts
    submitButton.prop('disabled', true).html('WAIT FOR ALL FILES TO BE LOADED...');
    

    $.ajax({
      url: '{% url "upload_HUB_files" %}', // point to server-side URL
      dataType: 'json', // what to expect back from server
      cache: false,
      contentType: false,
      processData: false,
      data: form_data,
      type: 'post',

      success: function (response) { // display success response        

        $('#msg').html('<div class="alert alert-success alert-dismissible fade show" role="alert">' +
                                   '<i class="bi bi-check-circle-fill me-1"></i>' + response.msg +
                                   '<button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>' +
                                   '</div>');


        document.getElementById('HUBmultiFiles').value = ''; // clear the file input field


        // Append the uploaded file names to the uploaded_list div
        var uploadedList = $('#uploaded_list ul.list-group');
        var files = response.files; // Assuming the server returns the list of files in a 'files' attribute
        for (var i = 0; i < files.length; i++) {
            uploadedList.append('<li class="list-group-item">' + files[i] + '</li>');
        }

        setTimeout(function() {
                    location.reload();
                }, 3000); // 3000 milliseconds = 3 seconds
        // Restore the submit button text after a short delay (1.5 seconds in this case)
        setTimeout(function () {
          submitButton.prop('disabled', false).html('Upload HUB Files');
        }, 1500);
      },

      error: function (response) {
        $('#msg').html('<div class="alert alert-success alert-dismissible fade show" role="alert">' +
                                   '<i class="bi bi-check-circle-fill me-1"></i>' + response.msg +
                                   '<button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>' +
                                   '</div>');
        document.getElementById('HUBmultiFiles').value = ''; // clear the file input field

        // Restore the submit button text after a short delay (1.5 seconds in this case)
        setTimeout(function () {
          submitButton.prop('disabled', false).html('Upload Multiple Files');
        }, 3500);
      }
    });
  });// end






// for the LAB uploadds 
$('#LABupload').on('click', function () {
    var form_data = new FormData();
    var ins = document.getElementById('LABmultiFiles').files.length;
    var submitButton = $('#LABupload'); // Get the submit button
    var status='Lab'

    if (ins == 0) {
      $('#msg').html('<div class="alert alert-danger" role="alert">Select at least one file</div>');
      return;
    }

    for (var x = 0; x < ins; x++) {
      form_data.append("LABfiles[]", document.getElementById('LABmultiFiles').files[x]);
      
    }

        // Append the status to the form data
    form_data.append("status", status);

    csrf_token = $('input[name="csrfmiddlewaretoken"]').val();
    form_data.append("csrfmiddlewaretoken", csrf_token);

    // Change the submit button text to "WAITING" when the AJAX request starts
    submitButton.prop('disabled', true).html('WAIT FOR ALL FILES TO BE LOADED...');
    

    $.ajax({
      url: '{% url "upload_HUB_files" %}', // point to server-side URL
      dataType: 'json', // what to expect back from server
      cache: false,
      contentType: false,
      processData: false,
      data: form_data,
      type: 'post',
      xhr: function() {
            var xhr = new window.XMLHttpRequest();
            console.log('Progress event triggered'); // Add this
            xhr.upload.addEventListener("progress", function(evt) {
                if (evt.lengthComputable) {
                    var percentComplete = evt.loaded / evt.total;
                    percentComplete = parseInt(percentComplete * 100);
                    $('.progress-bar').css('width', percentComplete + '%').attr('aria-valuenow', percentComplete).text(percentComplete + '%');
                }
            }, false);
            return xhr;
        },

      success: function (response) { // display success response
        $('#msg').html('<div class="alert alert-success alert-dismissible fade show" role="alert">' +
                                   '<i class="bi bi-check-circle-fill me-1"></i>' + response.msg +
                                   '<button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>' +
                                   '</div>');
        document.getElementById('LABmultiFiles').value = ''; // clear the file input field

            // Append the uploaded file names to the uploaded_list div
        var uploadedList = $('#uploaded_list ul.list-group');
        var files = response.files; // Assuming the server returns the list of files in a 'files' attribute
        for (var i = 0; i < files.length; i++) {
            uploadedList.append('<li class="list-group-item">' + files[i] + '</li>');
        }

        // Restore the submit button text after a short delay (1.5 seconds in this case)
        setTimeout(function () {
          submitButton.prop('disabled', false).html('Upload LAB Files');
        }, 1500);

        $('.progress-bar').css('width', '0%').attr('aria-valuenow', 0).text('0%'); // Reset the progress bar

        setTimeout(function() {
                    location.reload();
                }, 3000); // 3000 milliseconds = 3 seconds
      },

      error: function (response) {
        $('#msg').html('<div class="alert alert-success alert-dismissible fade show" role="alert">' +
                                   '<i class="bi bi-check-circle-fill me-1"></i>' + response.msg +
                                   '<button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>' +
                                   '</div>');
        document.getElementById('LABmultiFiles').value = ''; // clear the file input field

        // Restore the submit button text after a short delay (1.5 seconds in this case)
        setTimeout(function () {
          submitButton.prop('disabled', false).html('Upload Multiple Files');
        }, 3500);
        $('.progress-bar').css('width', '0%').attr('aria-valuenow', 0).text('0%'); // Reset the progress bar
      }
    });
  });// end


//----------------------------------------Riders and Relief ---------------------------------------------------------->

// for the LAB uploadds 
$('#ISTupload').on('click', function () {
    var form_data = new FormData();
    var ins = document.getElementById('ISTmultiFiles').files.length;
    var submitButton = $('#ISTupload'); // Get the submit button
   

    if (ins == 0) {
      $('#msg').html('<div class="alert alert-danger" role="alert">Select at least one file</div>');
      return;
    }

    for (var x = 0; x < ins; x++) {
      form_data.append("ISTfiles[]", document.getElementById('ISTmultiFiles').files[x]);
      
    }

  

    csrf_token = $('input[name="csrfmiddlewaretoken"]').val();
    form_data.append("csrfmiddlewaretoken", csrf_token);

    // Change the submit button text to "WAITING" when the AJAX request starts
    submitButton.prop('disabled', true).html('WAIT WHILE ANALYSING DATA...');
    

    $.ajax({
      url: '{% url "upload_IST_files" %}', // point to server-side URL
      dataType: 'json', // what to expect back from server
      cache: false,
      contentType: false,
      processData: false,
      data: form_data,
      type: 'post',
      xhr: function() {
            var xhr = new window.XMLHttpRequest();
            console.log('Progress event triggered'); // Add this
            xhr.upload.addEventListener("progress", function(evt) {
                if (evt.lengthComputable) {
                    var percentComplete = evt.loaded / evt.total;
                    percentComplete = parseInt(percentComplete * 100);
                    $('.progress-bar').css('width', percentComplete + '%').attr('aria-valuenow', percentComplete).text(percentComplete + '%');
                }
            }, false);
            return xhr;
        },

      success: function (response) { // display success response
        submitButton.prop('disabled', false).html('Check the status in the message box above');
        $('#msg').html('<div class="alert alert-success alert-dismissible fade show" role="alert">' +
                                   '<i class="bi bi-check-circle-fill me-1"></i>' + response.msg +
                                   '<button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>' +
                                   '</div>');
        document.getElementById('ISTmultiFiles').value = ''; // clear the file input field

            // Append the uploaded file names to the uploaded_list div
        var uploadedList = $('#uploaded_list ul.list-group');
        var files = response.files; // Assuming the server returns the list of files in a 'files' attribute
        for (var i = 0; i < files.length; i++) {
            uploadedList.append('<li class="list-group-item">' + files[i] + '</li>');
        }

        // Restore the submit button text after a short delay (1.5 seconds in this case)
        setTimeout(function () {
          submitButton.prop('disabled', false).html('Upload IST File');
        }, 1500);

        $('.progress-bar').css('width', '0%').attr('aria-valuenow', 0).text('0%'); // Reset the progress bar

        // setTimeout(function() {
        //             location.reload();
        //         }, 3000); // 3000 milliseconds = 3 seconds
      },

      error: function (response) {
        $('#msg').html('<div class="alert alert-success alert-dismissible fade show" role="alert">' +
                                   '<i class="bi bi-check-circle-fill me-1"></i>' + response.msg +
                                   '<button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>' +
                                   '</div>');
        document.getElementById('ISTmultiFiles').value = ''; // clear the file input field

        // Restore the submit button text after a short delay (1.5 seconds in this case)
        setTimeout(function () {
          submitButton.prop('disabled', false).html('Upload IST Files');
        }, 3500);
        $('.progress-bar').css('width', '0%').attr('aria-valuenow', 0).text('0%'); // Reset the progress bar
      }
    });
  });// end



//------------------------------UPLOADING SMS -----------------------------------------------------------------------------------

// for the LAB uploadds 
$('#smsupload').on('click', function () {
  var form_data = new FormData();
  var ins = document.getElementById('smsfiles[]').files.length;
  var submitButton = $('#smsupload'); // Get the submit button
 

  if (ins == 0) {
    $('#msg').html('<div class="alert alert-danger" role="alert">Select at least one file</div>');
    return;
  }

  for (var x = 0; x < ins; x++) {
    form_data.append("smsfiles[]", document.getElementById('smsfiles[]').files[x]);
    
  }



  csrf_token = $('input[name="csrfmiddlewaretoken"]').val();
  form_data.append("csrfmiddlewaretoken", csrf_token);

       
  // Change button color to blue to indicate it's active
  submitButton.css({'background-color': 'lightblue', 'color': 'black'});
  // Disable the button and show a bootstrap spinner
  submitButton.prop('disabled', true).html('<span class="spinner-border spinner-border-sm"   style="opacity: 0.5;" role="status" aria-hidden="true"></span> Uploading ..SMS..file....');


  

  $.ajax({
    url: '{% url "upload_SMS_files" %}', // point to server-side URL
    dataType: 'json', // what to expect back from server
    cache: false,
    contentType: false,
    processData: false,
    data: form_data,
    type: 'post',
    xhr: function() {
          var xhr = new window.XMLHttpRequest();
          console.log('Progress event triggered'); // Add this
          xhr.upload.addEventListener("progress", function(evt) {
              if (evt.lengthComputable) {
                  var percentComplete = evt.loaded / evt.total;
                  percentComplete = parseInt(percentComplete * 100);
                  $('.progress-bar').css('width', percentComplete + '%').attr('aria-valuenow', percentComplete).text(percentComplete + '%');
              }
          }, false);
          return xhr;
      },

    success: function (response) { // display success response
      submitButton.prop('disabled', false).html('Check the status in the message box above');
      $('#msg').html('<div class="alert alert-success alert-dismissible fade show" role="alert">' +
                                 '<i class="bi bi-check-circle-fill me-1"></i>' + response.msg +
                                 '<button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>' +
                                 '</div>');
      document.getElementById('smsfiles[]').value = ''; // clear the file input field

          // Append the uploaded file names to the uploaded_list div
      var uploadedList = $('#uploaded_list ul.list-group');
      var files = response.files; // Assuming the server returns the list of files in a 'files' attribute
      for (var i = 0; i < files.length; i++) {
          uploadedList.append('<li class="list-group-item">' + files[i] + '</li>');
      }


  
      // Restore the submit button text after a short delay (1.5 seconds in this case)
      setTimeout(function () {
        submitButton.prop('disabled', false).html('Upload SMS File');
      }, 1500);

      $('.progress-bar').css('width', '0%').attr('aria-valuenow', 0).text('0%'); // Reset the progress bar

      setTimeout(function() {
        location.reload();
    }, 3000); // 3000 milliseconds = 3 seconds

    },

    error: function (response) {
      $('#msg').html('<div class="alert alert-error alert-dismissible fade show" role="alert">' +
                                 '<i class="bi bi-check-circle-fill me-1"></i>' + response.msg +
                                 '<button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>' +
                                 '</div>');
      document.getElementById('smsfiles[]').value = ''; // clear the file input field

      // Restore the submit button text after a short delay (1.5 seconds in this case)
      setTimeout(function () {
        submitButton.prop('disabled', false).html('Upload SMS Files');
      }, 3500);
      $('.progress-bar').css('width', '0%').attr('aria-valuenow', 0).text('0%'); // Reset the progress bar

      setTimeout(function() {
        location.reload();
    }, 3000); // 3000 milliseconds = 3 seconds
    }
  });
});// end


//----------------------------------------------------------------------------------------------->


  $(document).ready(function(){
    // When the delete icon is clicked
    $(".delete_uploaded_creation").click(function(e){
        e.preventDefault();
        
        // Store the data attributes in the modal for later retrieval
        $("#confirmModal").data('update_date', $(this).data('update_date'));
        $("#confirmModal").data('sourcefile', $(this).data('sourcefile'));
        $("#confirmModal").data('user', $(this).data('user'));
        $("#confirmModal").data('status', $(this).data('status'));
        
        // Show the modal
        $("#confirmModal").modal('show');
    });

    // When the confirm deletion button inside the modal is clicked
    $("#confirmDelete").click(function(){
        let update_date = $("#confirmModal").data('update_date');
        let sourcefile = $("#confirmModal").data('sourcefile');
        let user = $("#confirmModal").data('user');
        let status = $("#confirmModal").data('status');
        
        $.ajax({
            type: "POST",
            url: "/delete_record_sie/", 
            data: {
                'update_date': update_date,
                'sourcefile': sourcefile,
                'user': user,
                'status': status,
                'csrfmiddlewaretoken': $("input[name='csrfmiddlewaretoken']").val(),
            },
            success: function(response){
                $('#msg').html('<div class="alert alert-success alert-dismissible fade show" role="alert">' +
                                   '<i class="bi bi-check-circle-fill me-1"></i>' + response.msg +
                                   '<button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>' +
                               '</div>');

                //Wait for 3 seconds and then reload the page
                setTimeout(function() {
                    location.reload();
                }, 3500); // 3000 milliseconds = 3 seconds

                // Close the modal
                $("#confirmModal").modal('hide');
            }
        });
    });
});


//deleting VL RECEIVED 
// $(document).ready(function(){
    // When the delete icon is clicked
    // $(".delete_uploaded_vl_received").click(function(e){
    //     e.preventDefault();
        
    //     // Store the data attributes in the modal for later retrieval
    //     $("#confirmModal").data('vlupdate_date', $(this).data('vlupdate_date'));
    //     $("#confirmModal").data('vlsourcefile', $(this).data('vlsourcefile'));
    //     $("#confirmModal").data('vluser', $(this).data('vluser'));
       
        
    //     // Show the modal
    //     $("#confirmModal").modal('show');
    // });

    // When the confirm deletion button inside the modal is clicked
//     $("#confirmDelete").click(function(){
//         let update_date = $("#confirmModal").data('vlupdate_date');
//         let sourcefile = $("#confirmModal").data('vlsourcefile');
//         let user = $("#confirmModal").data('vluser');
  
        
//         $.ajax({
//             type: "POST",
//             url: "/delete_record_vl_received/", 
//             data: {
//                 'update_date': vlupdate_date,
//                 'sourcefile': vlsourcefile,
//                 'user': vluser,
         
//                 'csrfmiddlewaretoken': $("input[name='csrfmiddlewaretoken']").val(),
//             },
//             success: function(response){
//                 $('#msg').html('<div class="alert alert-success alert-dismissible fade show" role="alert">' +
//                                    '<i class="bi bi-check-circle-fill me-1"></i>' + response.msg +
//                                    '<button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>' +
//                                '</div>');

//                 //Wait for 3 seconds and then reload the page
//                 setTimeout(function() {
//                     location.reload();
//                 }, 3500); // 3000 milliseconds = 3 seconds

//                 // Close the modal
//                 $("#confirmModal").modal('hide');
//             }
//         });
//     });
// });


// deleting dashboard

$(document).ready(function(){
    // When the delete icon is clicked
    $(".delete_uploaded_dashboard").click(function(e){
        e.preventDefault();
        
        // Store the data attributes in the modal for later retrieval
        $("#confirmModal").data('update_date', $(this).data('update_date'));
        $("#confirmModal").data('sourcefile', $(this).data('sourcefile'));
        $("#confirmModal").data('unique_key', $(this).data('unique_key'));
    
        var myModal = new bootstrap.Modal(document.getElementById('confirmModal'));
        // Show the modal
        $("#confirmModal").modal('show');
    });

    // When the confirm deletion button inside the modal is clicked
    $("#confirmDelete").click(function(){
        let update_date = $("#confirmModal").data('update_date');
        let sourcefile = $("#confirmModal").data('sourcefile');
        let unique_key = $("#confirmModal").data('unique_key');
        console.log(unique_key)
        
      
        
        $.ajax({
            type: "POST",
            url: "/delete_Dashboard_Entry/", 
            data: {
                'update_date': update_date,
                'sourcefile': sourcefile,
                'unique_key': unique_key,
              
                'csrfmiddlewaretoken': $("input[name='csrfmiddlewaretoken']").val(),
            },
            success: function(response){
                $('#msg').html('<div class="alert alert-success alert-dismissible fade show" role="alert">' +
                                   '<i class="bi bi-check-circle-fill me-1"></i>' + response.msg +
                                   '<button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>' +
                               '</div>');

                //Wait for 3 seconds and then reload the page
                setTimeout(function() {
                    location.reload();
                }, 3500); // 3000 milliseconds = 3 seconds

                // Close the modal
                $("#confirmModal").modal('hide');
            }
        });
    });
});



});


</script>


{% endblock content %}